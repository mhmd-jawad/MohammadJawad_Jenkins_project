pipeline {
  agent any
  environment { VENV = ".venv" }
  options { timestamps() }

  stages {

    stage('Setup') {
      steps {
        dir('jenkins_project') {
          bat '''
            rem === Locate a Python interpreter for the Jenkins service ===
            set "PYEXE=C:\\Windows\\py.exe"
            if not exist "%PYEXE%" set "PYEXE=C:\\Program Files\\Python312\\python.exe"
            if not exist "%PYEXE%" set "PYEXE=C:\\Program Files\\Python311\\python.exe"
            if not exist "%PYEXE%" set "PYEXE=%USERPROFILE%\\AppData\\Local\\Programs\\Python\\Python312\\python.exe"
            if not exist "%PYEXE%" set "PYEXE=%USERPROFILE%\\anaconda3\\python.exe"

            if not exist "%PYEXE%" (
              echo ERROR: No system Python found for Jenkins service.
              exit /b 1
            )

            "%PYEXE%" --version

            if not exist %VENV% ("%PYEXE%" -m venv %VENV%)
            ".\\%VENV%\\Scripts\\python" -m pip install --upgrade pip
            ".\\%VENV%\\Scripts\\python" -m pip install -r requirements.txt
          '''
        }
      }
    }

    stage('Lint') {
      steps {
        dir('jenkins_project') {
          script {
            // run flake8 but do NOT fail the build if it returns non-zero
            def rc = bat(returnStatus: true, script: '"./%VENV%/Scripts/flake8" app.py')
            echo "flake8 exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Lint warnings/errors present (marking UNSTABLE, continuing).'
            }
          }
        }
      }
    }

    stage('Test') {
      steps {
        dir('jenkins_project') {
          // if you want tests to be non-fatal too, wrap like Lint with returnStatus
          bat '"./%VENV%/Scripts/pytest" -q --junitxml=test-results.xml'
        }
      }
    }

    stage('Coverage') {
      steps {
        dir('jenkins_project') {
          script {
            def rc = bat(returnStatus: true, script: '''
              ".\\%VENV%\\Scripts\\coverage" run -m pytest -q
              ".\\%VENV%\\Scripts\\coverage" xml -o coverage.xml
              ".\\%VENV%\\Scripts\\coverage" report -m > coverage.txt
            ''')
            echo "coverage step exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Coverage step had issues (marking UNSTABLE, continuing).'
            }
          }
        }
      }
    }

   stage('Security Scan') {
  steps {
    dir('jenkins_project') {
      script {
        // Run Bandit but never affect the build result
        def rc = bat(returnStatus: true, script: '''
          ".\\%VENV%\\Scripts\\bandit" -r . --severity-level high --confidence-level high -f json -o bandit.json
        ''')
        echo "bandit exit code = ${rc} (ignored for build status)"
        // DO NOT set currentBuild.result here -> build remains SUCCESS
       }
     }
   }
 }


    stage('Deploy') {
      steps {
        dir('jenkins_project') {
          bat '''
            if not exist dist mkdir dist
            ".\\%VENV%\\Scripts\\python" app.py > dist\\output.txt
          '''
          powershell 'Compress-Archive -Path app.py, requirements.txt -DestinationPath dist\\app_bundle.zip -Force'
        }
      }
    }
  }

  post {
    always {
      dir('jenkins_project') {
        archiveArtifacts artifacts: 'test-results.xml,coverage.xml,coverage.txt,bandit.json,dist/**', fingerprint: true
      }
      cleanWs()
    }
  }
}
